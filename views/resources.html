<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<base href="/">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
	<link rel="shortcut icon" href="/img/logo-icon.png"/>
	<link rel="stylesheet" type="text/css" href="css/checkbox.css">
    <title>MaxDrive</title>
	<style>
		html, body {
			height: 100%;
		}
		.fill { 
			min-height: 100%;
			height: 100%;
			background-color: #957bbe; 
			border-radius: .25rem;
			background-size: cover;
		}
		.vertical-center {
		  min-height: 100%;  /* Fallback for browsers do NOT support vh unit */
		  min-height: 100vh; /* These two lines are counted as one :-)       */
		  display: flex;
		  align-items: center;
		}
		.sidenav {
		  height: 100%;
		  width: 250px;
		  position: fixed;
		  z-index: 1;
		  top: 0;
		  left: 0;
		  background-color: 	#808080;
		  overflow-x: hidden;
		  transition: 0.5s;
		  
		}
		.sidenav a {
		  padding: 6px 8px 6px 16px;
		  text-decoration: none;
		  font-size: 25px;
		  color: #ffffff;
		  display: block;
		  padding: 20px;
		}
		.hamburger div{
		  width: 35px;
		  height: 5px;
		  background-color: black;
		  margin: 6px 0;
		}
		.hidden_nav{
			width: 0px;
			padding: 0px;
		}
		.hidden_main{
			margin-left: 0px;
		}
		#main{
			margin-left: 250px; /* Reset margin */
			transition: 0.5s;
		}
		.progress{
			position:absolute; 
			bottom:0px;
			width: 80%;
			margin: 10%;
		}
		.progress_desc{
			position:absolute; 
			bottom:10px;
			margin: 20%;
		}
		.dot {
		  height: 5px;
		  width: 5px;
		  margin: 2px;
		  background-color: #bbb;
		  border-radius: 50%;
		  display: inline-block;
		}
		.more-btn{
			width: 40px;
			overflow: auto;
		}
		.more-btn:hover > .dot{
			background-color: red;
		}
		
		tr:hover > td > button{
			background-color: red;
			display: block !important;
		}
		
		td{
			padding: 10px !important;
		}
		
		@media only screen and (min-width: 768px) {
		  #open_menu{
			display: none;
		  }
		}
		
		@media only screen and (min-width: 992px) {
		 #action-btn {
			display: none;
		  }
		}
		#action-menu-lg{
			margin-top: 100px;
		}
	</style>
	</head>
	<body>
	
	<div id="side_menu" class="sidenav">
		<a href="#about">Files</a>
		<a href="#clients">Shared</a>
		<a href="#contact">Favourites</a>
		<a href="#contact">Deleted</a>
		<h6 class="progress_desc">2MB used of 10MB</h6>
		<div class="progress">
			<div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
		</div>
	</div>
	<div id="main">
		<nav class="navbar navbar-expand-md navbar-light bg-light">
		  
		  <button id="open_menu" class="btn btn-outline-success" type="button">Side Menu</button>
		  
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		  
		  
		  
		  <div class="collapse navbar-collapse" id="navbarSupportedContent">
		  <a  href="#"><img src="/img/logo.png"></a>
			<ul class="navbar-nav mr-auto"></ul>
			<form class="form-inline my-2 my-lg-0">
				
			  <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
			  <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
			  <ul class="navbar-nav mr-auto">
			  <li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				  <%= user.email %>
				</a>
				<div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
				  <a class="dropdown-item" href="#">Change Password</a>
				  <div class="dropdown-divider"></div>
				  <a class="dropdown-item" href="/logout" onclick="delete_cookie('jwt');">Log Out</a>
				</div>
			  </li>
			</ul>
			</form>
		  </div>
		</nav>
		
		<div class="container-fluid">
			<div class="row">
				<div class="col-lg-10 col-md-12">
					<div id="breadcrumb"></div>
					
					<div id="resource-table"></div>
				</div>
				<div id="action-menu-lg" class="col d-none d-lg-block">
					<button type="button" class="btn btn-outline-primary btn-block">Upload Files</button>
					<button type="button" class="btn btn-outline-primary btn-block">Upload Folder</button>
					<button type="button" class="btn btn-outline-secondary btn-block">New Shared Folder</button>
					<button type="button" class="btn btn-outline-secondary btn-block" onclick="generate_text_modal('Folder', 'Enter your folder name', false, 'Create', create_folder, {});">New Folder</button>
				</div>
			  </div>
		</div>
</div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="/js/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
	<script src="/js/notify.min.js"></script>
	
	<script>
		
		/* Error Codes:
			-1: Failed to PUT user basic JSON schema.
		*/
		
		var user_id = "<%= user._id %>";
		console.log(user_id);
		
		var side_nav_open = true;
		
		const el_factory = (type, attributes, ...children) => {
		  const el = document.createElement(type)

		  for (key in attributes) {
			el.setAttribute(key, attributes[key])
		  }

		  children.forEach(child => {
			if (typeof child === 'string') {
			  el.appendChild(document.createTextNode(child))
			} else {
			  el.appendChild(child)
			}
		  })

		  return el
		}
		
		function delete_cookie( name ) {
		  document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
		}
		
		var breadcrumb = new breadcrumb('breadcrumb');
		var datatable = new datatable("resource-table", ["Name", "Type", "Sharing", "Size"]);
		
		
		document.getElementById('open_menu').addEventListener('click', function(){
			console.log(9);
			openNav();
		});
		
		/* The datatable class encapsulates all functions needed to create and manipulate a datatable on the DOM. */
		function datatable(target, headers){
				
				this.platform = "";
				
				this.render = function(){
					this.empty();
					/* Get user data. */
					var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function() {
						/* User data success function. */
						if (this.readyState == 4 && this.status == 200) {
							var user = JSON.parse(this.responseText);
							
							/* Add basic JSON schema on users first load. */
							if(user[0].resources.length == 0){
								user[0].resources.push({"type": "folder", "items": []});
								/* POST */
								var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 
								xmlhttp.open("PUT", "/api/users/" + user_id);
								xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
								xmlhttp.onreadystatechange = function() {
									if (this.readyState != 4 || this.status != 200)
										return $.notify("Something bad happened. Error code -1", "error"); 
								}
								xmlhttp.send(JSON.stringify({"user" : user[0]}));
							}
							
							/* Build breadcrumb from url. */
							var url_breadcrumbs = window.location.href.split('resources')[1].split('/');
							
							breadcrumb.reset();
							
							for(var i = 1; i < url_breadcrumbs.length; i++){
								breadcrumb.add(url_breadcrumbs[i]);
							}
							
							console.log(breadcrumb.items);
							
							/* Find target folder. */
							var folder = user[0].resources[0];
							var found_flag = false;
							for(var i = 1; i < breadcrumb.items.length; i++){
								found_flag = false;
								/* Has the target folder been reached? */
								for(var j = 0; j < folder.items.length; j++){
									if(folder.items[j].name == breadcrumb.items[i]){
										folder = folder.items[j];
										found_flag = true;
									}
								}
							}
							
							if(breadcrumb.items.length == 1) found_flag = true;
							
							if(found_flag){
								/* Render the rows. */
								for(var i = 0; i < folder.items.length; i++)
									datatable.add_row([folder.items[i].name, folder.items[i].type, "private", folder.items[i].size]);
							} else {
								window.location.href = '/resources'
							}
					   }
					};
					xhttp.open("GET", '/api/users/' + user_id, true);
					xhttp.send(); 
				}
				
				/* Needs to be updated for screen sizing. Need to check for type for action menu. */
				this.add_row = function(columns){
					if(typeof columns === 'undefined') 
						return console.log("error: missing elements argument");
					//if(columns.length != this.num_col)
					//	return console.log("error: num elements must match the number if headers");
					var dt_row = document.createElement("tr");
					dt_row.appendChild(this.generate_checkbox(function(){
						console.log("row select");
					}));
					/* One column on mobile. */
					if(window.innerWidth < 768){
						columns.length = 1;
					}
					for(var i = 0; i < columns.length; i++)
						dt_row.appendChild(el_factory('td', {}, columns[i]));
					var btn = this.generate_action_btn(null, [
						{"star": function(){console.log('clicked star')}},
						{"delete": function(){console.log('clicked delete');
							//console.log();
							delete_resource(this.parentNode.parentNode.parentNode.parentNode.childNodes[1].innerHTML);
						}},
						{"rename": function(){console.log('clicked rename')}},
						{"move": function(){console.log('clicked moved')}}
					]);
					dt_row.appendChild(btn);
					document.getElementById(this.target + '-body').appendChild(dt_row);
				}
				
				this.action_btn = function(id){
					this.add_item = function(name, callback){
						var item = el_factory('button', {class:'dropdown-item', type:'button', onclick:callback}, name);
						return item;
					}
				}
				
				this.generate_action_btn = function(id, items){
					var attr = (id != null) ? { class:'more-btn', id: id, 'data-toggle':"dropdown" } : { class:'more-btn', 'data-toggle':"dropdown" };
					var btn = el_factory('div', attr,
							el_factory('span', {class: 'dot'}),
							el_factory('span', {class: 'dot'}),
							el_factory('span', {class: 'dot'}))
					var inner_div = el_factory('div', {class: 'dropdown-menu dropdown-menu-right'});
					for(var i = 0; i < items.length; i++){
						for(prop in items[i]){
							var item = el_factory('button', {class:'dropdown-item', type:'button'}, prop);
							item.addEventListener('click', items[i][prop], false);
							inner_div.appendChild(item);
						}
					}
					var th = el_factory('th', {style:'width:10%;'}, el_factory('div', {class:'dropdown'}, btn, inner_div));
					
					return th;
				}
				
				/* Removes all nodes from the table's body. */
				this.empty = function(){
					var myNode = document.getElementById(this.target + '-body');
					while (myNode.firstChild) {
						myNode.removeChild(myNode.firstChild);
					}
				}
				
				this.destroy = function(){
					var element = document.getElementById(this.target);
					element.removeChild(element.childNodes[0]);
				}
				
				this.generate_checkbox = function(click_event){
					var checkbox = el_factory('input', {type: 'checkbox'});
					checkbox.addEventListener('click', click_event);
					return el_factory('td', {style: "width: 10px;"}, el_factory('label', {class: "container"}, checkbox, el_factory('span', {class: "checkmark"})));
				}
				
				/* Constructor */
				this.init = function(target, headers){
					if(target === 'undefined')
						return console.log("error: table target required");
					this.target = target;
					this.num_col = headers.length;
					var dt_row = document.createElement("tr");
					dt_row.appendChild(this.generate_checkbox(function(e){
						console.log(e);
						console.log("header select");
					}));
					/* One column on mobile. */
					if(window.innerWidth < 768){
						headers.length = 1;
					}
					for(var i = 0; i < headers.length; i++)
						dt_row.appendChild(el_factory('th', {}, headers[i]));
					dt_row.appendChild(this.generate_action_btn("action-btn", [
					{"Upload Files": function(){console.log('clicked Upload files')}},
					{"Upload Folder": function(){console.log('clicked Upload folder')}},
					{"New Shared Folder": function(){console.log('clicked New Shared Folder')}},
					{"New Folder": function(){ generate_text_modal('Folder', 'Enter your folder name', false, 'Create', create_folder, {}); }}
					]));	
					var dt = el_factory('table', {class: 'table'}, 
								el_factory('thead', {}, dt_row), el_factory('tbody', {id: this.target + '-body'})
							);
					document.getElementById(target).appendChild(dt);
				}
				
				this.init(target, headers);
			}
		
		document.addEventListener("DOMContentLoaded", function(event) {
			if(window.innerWidth < 768) {
				closeNav();
				datatable.platform = "mobile";
			} else if( window.innerWidth >= 768) {
				openNav();
				datatable.platform = "desktop";
			}
			datatable.render();
		});
		
		window.addEventListener("resize", function(){
			if(window.innerWidth < 768) {
				closeNav();
				if(datatable.platform == "desktop"){
					datatable.destroy();
					datatable.init("resource-table", ["Name"]);
					datatable.platform = "mobile"
					datatable.render();
				}
			} else if( window.innerWidth >= 768) {
				openNav();
				if(datatable.platform == "mobile"){
					datatable.destroy();
					datatable.init("resource-table", ["Name", "Type", "Sharing", "Size"]);
					datatable.platform = "desktop"
					datatable.render();
				}
			}
		});
		
		window.addEventListener("click", function(event){
			if(event.target.id !== 'side_menu' && event.target.id !== 'open_menu'){
				if(window.innerWidth < 768) {
					closeNav();
				}
			}
			//console.log(event);
			if(event.target.tagName == 'TD'){
				var href = "";
				for(var i = 0; i < breadcrumb.items.length; i++){
						href += '/' + breadcrumb.items[i];
				}
				href += '/' + event.target.parentNode.childNodes[1].innerHTML;
				console.log(href);
				window.location.href = href;
			}
		});
		
		/* Set the width of the sidebar to 250px and the left margin of the page content to 250px */
		function openNav() {
			side_nav_open=true;
			document.getElementById("side_menu").style.width = "250px";
			/* Don't shift main to right on small screen. */
			if(window.innerWidth >= 768) {
				document.getElementById("main").style.marginLeft = "250px";
			}
		}

		/* Set the width of the sidebar to 0 and the left margin of the page content to 0 */
		function closeNav() {
			side_nav_open=false;
			document.getElementById("side_menu").style.width = "0";
			document.getElementById("main").style.marginLeft = "0";
		}
		
		/* Dummy data used for testing purposes. */
		var data = {
			"folder_1":{
				"guid":1,
				"type":"folder",
				"items":{},
				"members":[{
					"email":"",
					"guid":"",
					"edit":""}
				],
				"link":{
					"url":"",
					"edit":""
				}
			},
			"file_1":{
				"guid":2,
				"type":"file",
				"members":[{
					"email":"",
					"guid":"",
					"edit":""}
				],
				"link":{
					"url":"",
					"edit":""
				}
			}
		};
		
		function breadcrumb(target){
			
			this.items = ['resources'];
			
			this.reset = function(){
				this.items.length = 1;
				var select = document.getElementById('breadcrumbs');
				while(select.firstChild)
					select.removeChild(select.firstChild);
				var breadcrumb = el_factory('li', {class: 'breadcrumb-item'}, el_factory('a', {href:'/resources'}, 'resources'));
				document.getElementById('breadcrumbs').appendChild(breadcrumb);
			}
			
			this.add = function(folder){
				this.items.push(folder);
				var href = "";
				for(var i = 0; i < this.items.length; i++){
					href += "/" + this.items[i];
				}
				var breadcrumb = el_factory('li', {class: 'breadcrumb-item'}, el_factory('a', {href:href}, folder))
				document.getElementById('breadcrumbs').appendChild(breadcrumb);
			}
			
			this.remove_last = function(){
				var select = document.getElementById('breadcrumbs');
				select.removeChild(select.lastChild);
			}
			
			/* Constructor */
			this.init = function(){
				
				var breadcrumb = el_factory('nav', {}, el_factory('ol', {class: 'breadcrumb', id: 'breadcrumbs'}, 
					el_factory('li', {class: 'breadcrumb-item'}, el_factory('a', {href:'/resources'}, 'resources')),
				));
				document.getElementById(target).appendChild(breadcrumb);
			}
			
			this.init();
		
		}
		
		/*
		|--------------------------------------------------------------------------
		| FUNCTION: generate_text_modal
		|--------------------------------------------------------------------------
		|
		|	Generates and opens a modal with a text box. Invokes callback function on submit.
		| 	Appends user input to callback _ARGS.INPUT
		|
		*/
		function generate_text_modal(_TITLE, _PLACEHOLDER, _TEXT, _BUTTON_TEXT, _CALLBACK, _ARGS) {
			
			/* Generate Close Button. */
			var close_btn = el_factory('button', {type: "button", class: "close", "data-dismiss": "modal", "aria-label": "Close"}, el_factory('span', {"aria-hidden": "true"}, "x"));
			
			/* Generate Title. */
			var title = el_factory('label', {for: 'NewDocumentName', class: 'col-form-label', style: 'padding: 10px 0px; color: black; font-weight: normal; font-size: large;'}, _TITLE);

			/* Generate Input. */
			if (!_TEXT)
				_TEXT = "";
			var style = 'border: 1px solid gray !important; color:black !important; border-radius: 0; box-shadow: none !important; outline: none !important;';
			var input = el_factory('input', {type: 'text', placeholder: _PLACEHOLDER, class: 'form-control', id: 'modal_text_input', required: 'true', value: _TEXT, style: style});
	
			/* Generate Submit Button. */
			style = 'float: right; border: none !important; color: white !important; font-weight: bold; margin-top: 15px; padding: 7px 15px; background: #007bff; font-size: small;';
			var submit_btn = el_factory('input', {type: 'submit', 'value': _BUTTON_TEXT, style: style});
		
			/* Generate Form. */
			var form = el_factory('form', {id: 'modal_form'}, close_btn, title, input, submit_btn);
			
			/* Generate Modal. */
			var modal = el_factory('div', {class: 'modal fade', style: 'top: 30% !important;', id: 'text_modal', tabindex: '-1', role: 'dialog', 'aria-hidden': 'true'},
				el_factory('div', {class: 'modal-dialog', style: 'max-width: 350px !important;', role: 'document'},
					el_factory('div', {class: 'modal-content', style: 'border-radius: 0; box-shadow: 0px 0px 10px 1px grey;'},
						el_factory('div', {class: 'modal-body'}, form)
					)
				)
			);
	
		  $(document.body).append(modal);

		  /* Open the text modal. */
		  $('#text_modal').modal('toggle');
		  
		  $("#modal_form").submit(function(event) {
			/* Stop page reloading. */
			event.preventDefault();
			/* Get text input. */
			_ARGS.INPUT = document.getElementById("modal_text_input").value;
			/* Clear text input. */
			document.getElementById("modal_text_input").value = '';
			/* Invoke callback function. */
			_CALLBACK(_ARGS);
			/* Close the modal. */
			$('#text_modal').modal('toggle');
		  });
		  /* Destroy the modal on close. */
		  $('#text_modal').on('hidden.bs.modal', function() {
			var elem = document.querySelector('#text_modal');
			elem.parentNode.removeChild(elem);
		  })
		}
		
		function create_folder(args){

			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					
					var user = JSON.parse(this.responseText);
					
					/* Find target folder. */
					var folder = user[0].resources[0];
					for(var i = 1; i < breadcrumb.items.length; i++){
						/* Has the target folder been reached? */
						for(var j = 0; j < folder.items.length; j++){
							if(folder.items[j].name == breadcrumb.items[i]){
								folder = folder.items[j];
							}
						}
					}
					
					/* Check for duplicate folder names. */
					for(var i = 0; i < folder.items.length; i++){
						if(folder.items[i].name == args.INPUT){
							return $.notify("Folder \"" + args.INPUT + "\" already exists.", "error");
						}
					}
					
					folder.items.push({"name": args.INPUT, "size": "0MB", "type": "folder", items: []});
					
					//user[0].resources[0].items.length = 0;
					var xhttp1 = new XMLHttpRequest();
					xhttp1.onreadystatechange = function() {
						if (this.readyState == 4 && this.status == 200) {
							datatable.render();
							$.notify("Folder \"" + args.INPUT + "\" added.", "success");
						}
					};
					xhttp1.open("PUT", '/api/users/' + user_id, true);
					xhttp1.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
					xhttp1.send(JSON.stringify({"user":user[0]}));
					
			   }
			};
			xhttp.open("GET", '/api/users/' + user_id, true);
			xhttp.send(); 
		}
		
		function delete_resource(name){
		
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					
					var user = JSON.parse(this.responseText);
					
					/* Find target folder. */
					var folder = user[0].resources[0];
					for(var i = 1; i < breadcrumb.items.length; i++){
						/* Has the target folder been reached? */
						for(var j = 0; j < folder.items.length; j++){
							if(folder.items[j].name == breadcrumb.items[i]){
								folder = folder.items[j];
							}
						}
					}
					
					/* Remove resource. */
					for(var i = 0; i < folder.items.length; i++){
						if(folder.items[i].name == name)
							folder.items.splice(i, 1);
					}
					
					//user[0].resources[0].items.length = 0;
					var xhttp1 = new XMLHttpRequest();
					xhttp1.onreadystatechange = function() {
						if (this.readyState == 4 && this.status == 200) {
							datatable.render();
							$.notify("Folder \"" + name + "\" deleted.", "success");
						}
					};
					xhttp1.open("PUT", '/api/users/' + user_id, true);
					xhttp1.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
					xhttp1.send(JSON.stringify({"user":user[0]}));
					
			   }
			};
			xhttp.open("GET", '/api/users/' + user_id, true);
			xhttp.send(); 
		}
		
	</script>
  </body>
</html>