<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<base href="/">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
	<link rel="shortcut icon" href="/img/logo-icon.png"/>
	<link rel="stylesheet" type="text/css" href="css/checkbox.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jstree-bootstrap-theme@1.0.1/dist/themes/proton/style.min.css">
	
    <title>MaxDrive</title>
	<style>
		html, body {
			height: 100%;
		}
		.fill { 
			min-height: 100%;
			height: 100%;
			background-color: #957bbe; 
			border-radius: .25rem;
			background-size: cover;
		}
		.vertical-center {
		  min-height: 100%;  /* Fallback for browsers do NOT support vh unit */
		  min-height: 100vh; /* These two lines are counted as one :-)       */
		  display: flex;
		  align-items: center;
		}
		.hamburger div{
		  width: 35px;
		  height: 5px;
		  background-color: black;
		  margin: 6px 0;
		}
		.hidden_nav{
			width: 0px;
			padding: 0px;
		}
		.progress{
			position:absolute; 
			bottom:0px;
			width: 80%;
			margin: 10%;
		}
		.progress_desc{
			position:absolute; 
			bottom:10px;
			margin: 20%;
		}
		.dot {
		  height: 5px;
		  width: 5px;
		  margin: 2px;
		  background-color: #bbb;
		  border-radius: 50%;
		  display: inline-block;
		}
		.more-btn{
			width: 40px;
			overflow: auto;
		}
		.more-btn:hover > .dot{
			background-color: red;
		}
		
		tr:hover > td > button{
			background-color: red;
			display: block !important;
		}
		
		td{
			padding: 10px !important;
		}
		
		@media only screen and (min-width: 768px) {
		  #open_menu{
			display: none;
		  }
		}
		
	</style>
	</head>
	<body>
	

		<nav class="navbar navbar-expand-md navbar-light bg-light">
		  
		  
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		  
		  
		  
		  <div class="collapse navbar-collapse" id="navbarSupportedContent">
		  <a  href="#"><img src="/img/logo.png"></a>
			<ul class="navbar-nav mr-auto"></ul>
			<form class="form-inline my-2 my-lg-0">
				
			  <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
			  <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
			  <ul class="navbar-nav mr-auto">
			  <li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				  <%= client_email %>
				</a>
				<div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
				  <a class="dropdown-item" href="#">Change Password</a>
				  <div class="dropdown-divider"></div>
				  <a class="dropdown-item" href="/logout" onclick="delete_cookie('jwt');">Log Out</a>
				</div>
			  </li>
			</ul>
			</form>
		  </div>
		</nav>
		
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-12">
					<div id="resource-table"></div>
				</div>
			  </div>
		</div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="/js/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
	<script src="/js/notify.min.js"></script>
	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.283.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
	
	<script>
		
		var latest_folder_json = {};
		
		AWS.config.region = 'eu-west-2'; // Region
		AWS.config.credentials = new AWS.CognitoIdentityCredentials({
			IdentityPoolId: 'eu-west-2:ece4887c-a2dd-45e8-a766-6e445673b866',
		});

		var s3 = new AWS.S3({
		  apiVersion: '2006-03-01',
		  params: {Bucket: 'maxdrive'}
		});
		
		var side_nav_open = true;
		
		const el_factory = (type, attributes, ...children) => {
		  const el = document.createElement(type)

		  for (key in attributes) {
			el.setAttribute(key, attributes[key])
		  }

		  children.forEach(child => {
			if (typeof child === 'string') {
			  el.appendChild(document.createTextNode(child))
			} else {
			  el.appendChild(child)
			}
		  })

		  return el
		}
		
		function delete_cookie( name ) {
		  document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
		}
		
		document.addEventListener("DOMContentLoaded", function(event) {
			//resource_table.this_breadcrumbs.items = <%- breadcrumbs %>;
			latest_folder_json = <%- folder %>;
			resource_table.render(<%- folder %>);
			
		});
		
		window.addEventListener("resize", function(){
			if(window.innerWidth < 768) {
				if(resource_table.platform == "desktop"){
					resource_table.destroy();
					resource_table.init("resource-table", ["Name"]);
					resource_table.platform = "mobile"
					resource_table.render(function(){}, false, null, null);
				}
			} else if( window.innerWidth >= 768) {
				if(resource_table.platform == "mobile"){
					resource_table.destroy();
					resource_table.init("resource-table", ["Name", "Type", "Sharing", "Size"]);
					resource_table.platform = "desktop"
					resource_table.render(function(){}, false, null, null);
				}
			}
		});
		
		var resource_table = new datatable({
			"action_btn": true,
			"relocate": true,
			"headers": ["Name", "Type", "Sharing", "Size"],
			"target": "resource-table",
			"files": true,
			"select_btn": true,
			"breadcrumbs": true,
			"hdr_action_btn" : true
		});
		
		/* The datatable class encapsulates all functions needed to create and manipulate a datatable on the DOM. */
		function datatable(cfg){
			
			/* Could add a config object instead of parameters. */
			this.config = {
				"action_btn": cfg.action_btn,
				"relocate": cfg.relocate,
				"headers": cfg.headers,
				"target": cfg.target,
				"files" : cfg.files,
				"select_btn" : cfg.select_btn,
				"breadcrumbs" : cfg.breadcrumbs,
				"hdr_action_btn": cfg.hdr_action_btn 
			}
			
			/* Holds JSON for the render function to use. */
			this._data = null;
			
			this.selected = [];
			
			this.platform = "";

			this.this_breadcrumbs = {};
			
			/* Breadcrumbs class. */
			this.breadcrumbs = function(target, parent){
		
				this.items = [];
				
				/* Creates a breadcrumb navigation using the items array. */
				this.update = function(data){
				
					var _this = this;
					/* Empty the breadcrumbs body. */
					var el = document.getElementById(target + '-breadcrumbs');
					while(el.firstChild)
						el.removeChild(el.firstChild);
					/* Add breadcrumb items to the breadcrumbs. */
					for(var i = 0; i < _this.items.length; i++){
						var href = "/api/users/" + "<%- owner._id %>" + "/resources/" + _this.items[i].guid
						var breadcrumb = el_factory('li', {class: 'breadcrumb-item', 'data-index': i}, el_factory('a', {href:href}, this.items[i].name));
						document.getElementById(target + '-breadcrumbs').appendChild(breadcrumb);
					}
				}
				
				/* Constructor */
				this.init = function(){
					document.getElementById(target).appendChild(el_factory('nav', {}, el_factory('ol', {class: 'breadcrumb', id: target + '-breadcrumbs'})));
				}
				this.init();
			}
			
			/* Gets the current folder from breadcrumbs and renders or updates using the callback function. */
			this.render = function(resource){
				
				var _this = this;
				
				/* Reset selected on render. */
				this.selected.length = 0;
			
				/* Remove all elements from the table's body. */
				_this.empty();
				_this.this_breadcrumbs.items.length = 0;
				_this.this_breadcrumbs.items = <%- breadcrumbs %>;
				_this.this_breadcrumbs.update(_this._data);
				
				if(resource.type == 'file'){
					_this.add_row([resource.name, resource.type, "TBC", "TBC"], i, resource.guid);
				} else if (resource.type == 'folder'){
					for(var i = 0; i < resource.items.length; i++){
						if(resource.items[i].type == 'folder' || (resource.items[i].type == 'file' && _this.config.files == true))
							_this.add_row([resource.items[i].name, resource.items[i].type, "TBC", "TBC"], i, resource.items[i].guid);
					}
				}
			}
			
			/* Get the latest datatable JSON and render. */
			this.update = function(){
				var _this = this;			
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function(){
					if(this.readyState == 4 && this.status == 200){
						latest_folder_json = JSON.parse(this.responseText);
						_this.render(JSON.parse(this.responseText));
					}
					else{
						console.log(this.responseText);
					}
				}
				var folder = <%- folder %>;
				console.log();
				var url = "/api/users/" + "<%- owner._id %>" + "/" + this.this_breadcrumbs.items[this.this_breadcrumbs.items.length -1].guid + '/false';
				console.log(url);
				xhttp.open("GET", url);
				xhttp.send();
			}
			
			/* Need to check for resource type for action menu. */
			this.add_row = function(columns, index, guid){
			
				var _this = this;
				/* Validation. */
				if(typeof columns === 'undefined') 
					return console.log("error: missing elements argument");
				var dt_row = document.createElement("tr");
				dt_row.setAttribute("data-index", index);
				dt_row.setAttribute("data-guid", guid);
				//if(columns[1].type == 'file'
				/* Click event listener. */
				var resource_type = columns[1];
				dt_row.addEventListener("click", function (event) {
					event.preventDefault();
					
					if(resource_type == 'folder'){
						if(event.target.classList[0] == "clickable"){
						
							var href = "/api/users/" + "<%- owner._id %>" + "/resources/" + this.dataset.guid;
							console.log(href);
							window.location.href = href;
				
						}
					}
					
				});
				
				if(_this.config.select_btn){
				
					dt_row.appendChild(this.generate_checkbox(function(event){
						/* Add absolute path to selected array. */
						
							var path = "";
							for(var i = 0; i < _this.this_breadcrumbs.items.length; i++){
									path += '/' + _this.this_breadcrumbs.items[i];
							}
							path += '/' + event.target.parentNode.parentNode.nextSibling.innerHTML;
							
							/* Check for duplicates. */
							var f_flg = false;
							for(var i = 0; i < _this.selected.length; i++){
								if(_this.selected[i] == path){
									f_flg = true;
									/* Remove. */
									_this.selected.splice(i, 1);
								}
							}
							
							if(!f_flg)
								_this.selected.push(path);
								
							console.log(_this.selected);
						//_this.this_breadcrumbs.items
					}))
				
				}
				/* One column on mobile. */
				if(window.innerWidth < 768 || _this.config.headers.length == 1){
					columns.length = 1;
				}
				for(var i = 0; i < columns.length; i++)
					dt_row.appendChild(el_factory('td', {class: 'clickable', style:'cursor: pointer;'}, columns[i].toString()));
				/* Add the action button if enabled. */
				if(_this.config.action_btn){
				
					var menu_items = [];
					
					var delete_item = {"delete": function(){
						
						var resource_id = this.parentNode.parentNode.parentNode.parentNode.dataset.guid;
						
						var xhttp = new XMLHttpRequest();
						xhttp.onreadystatechange = function(){
							if(this.status == 200 && this.readyState == 4){
								$.notify("Resource deleted", "success");
								latest_folder_json = JSON.parse(this.responseText);
								resource_table.render(JSON.parse(this.responseText));
							}
							else{
								console.log(this.responseText);
							}
						}
						var folder = <%- folder %>;
						xhttp.open("DELETE", "/api/users/" + "<%- owner._id %>" + "/resources/" + folder.guid);
						xhttp.setRequestHeader("Content-Type", "application/json");
						xhttp.send(JSON.stringify({target_id: resource_id}));

					}};
					
					var rename_item = {"rename": function(){
						
						var _this = this;
						
						var name = this.parentNode.parentNode.parentNode.parentNode.childNodes[1].innerHTML;

						generate_text_modal(columns[1], "Enter the new " + columns[1] + " name", name, "Rename", function(args){

							var resource_id = _this.parentNode.parentNode.parentNode.parentNode.dataset.guid;

							var xhttp = new XMLHttpRequest();
							xhttp.onreadystatechange = function(){
								if(this.status == 200 && this.readyState == 4){
									$.notify("Resource renamed.", "success");
									latest_folder_json = JSON.parse(this.responseText);
									resource_table.render(JSON.parse(this.responseText));
								}
								else{
									console.log(this.responseText);
								}
							}
							var folder = <%- folder %>;
							
							var target = null;
							for(var i = 0; i < folder.items.length; i++){
								if(folder.items[i].guid == resource_id){
									target = folder.items[i];
								}
							}
							
							target.name = args.INPUT;
							
							xhttp.open("PUT", "/api/users/" + "<%- owner._id %>" + "/resources/" + folder.guid);
							xhttp.setRequestHeader("Content-Type", "application/json");
							xhttp.send(JSON.stringify({target: target}));
							
						}, {});
					
					}};
					
					var move_item = {"move": function(){
						var resource_id = this.parentNode.parentNode.parentNode.parentNode.dataset.guid;
						generate_move_modal(resource_id);
					}};
					
					var download_item = {"download": function(){
						
						var guid = this.parentNode.parentNode.parentNode.parentNode.dataset.guid;
						
						var download_link = null;
						for(var i = 0; i < latest_folder_json.items.length; i++){
							if(latest_folder_json.items[i].guid == guid){
								download_link = latest_folder_json.items[i].revisions[latest_folder_json.items[i].revisions.length -1].download;
							}
						}
						
						function downloadURI(uri) {
							var link = document.createElement("a");
							link.href = uri;
							document.body.appendChild(link);
							link.click();
							document.body.removeChild(link);
							delete link;
						}
						
						downloadURI(download_link);

					}};
					
					/* Open a modal with a table detailing the version history of the file. */
					var ver_hist_item = { "version history" : function(){
						
						var guid = this.parentNode.parentNode.parentNode.parentNode.dataset.guid;
						
						var folder = latest_folder_json;
						
						/* Has the target folder been reached? */
						for(var i = 0; i < folder.items.length; i++){
							if(folder.items[i].guid == guid){
								folder = folder.items[i];
							}
						}
						
						/* Generate Close Button. */
						var close_btn = el_factory('button', {type: "button", class: "close", "data-dismiss": "modal", "aria-label": "Close"}, el_factory('span', {"aria-hidden": "true"}, "x"));
						
						/* Generate Title. */
						var title = el_factory('label', {for: 'NewDocumentName', class: 'col-form-label', style: 'padding: 10px 0px; color: black; font-weight: normal; font-size: large;'}, "Version History");
				
						/* Generate Form. */
						var form = el_factory('form', {id: 'modal_form'}, close_btn, title);
						
						/* Generate Modal. */
						var modal = el_factory('div', {class: 'modal fade', style: 'top: 30% !important;', id: 'ver_hist_modal', tabindex: '-1', role: 'dialog', 'aria-hidden': 'true'},
							el_factory('div', {class: 'modal-dialog', style: 'max-width: 350px !important;', role: 'document'},
								el_factory('div', {class: 'modal-content', style: 'border-radius: 0; box-shadow: 0px 0px 10px 1px grey;'},
									el_factory('div', {class: 'modal-body', id: 'ver-hist-modal-body'}, form)
								)
							)
						);
						
					  $(document.body).append(modal);
						
					
						var ver_hist_table = new datatable({
							"action_btn": true,
							"relocate": false,
							"headers": ["Name", "Size", "Date"],
							"target": "ver-hist-modal-body",
							"select_btn": false,
							"breadcrumbs": false
						});
						
						
						
						for(var i = 0; i < folder.revisions.length; i++){
							ver_hist_table.add_row([folder.revisions[i].name, folder.revisions[i].size, folder.revisions[i].date], i, folder.revisions[i].guid);
						}

						/* Open the text modal. */
						$('#ver_hist_modal').modal('toggle');
						/* Destroy the modal on close. */
						$('#ver_hist_modal').on('hidden.bs.modal', function() {
							var elem = document.querySelector('#ver_hist_modal');
							elem.parentNode.removeChild(elem);
						})
						
					}};
					
					/* Add a new file revision. */
					var update = {
						"update": function(){
							
							var _this = this;
						
							/* Open file dialog. */
							var file = el_factory('input', {type: 'file'});
							file.addEventListener('change', function(){
							
								/* Upload to AWS. */
								var file = this.files[0];

								/* Upload to AWS. */
								if (file) {
									/* Generate GUID for file name. */
									var guid = uuidv4();
									var objKey = "<%- owner._id %>" + '/' + guid;
									var params = {
										Key: objKey,
										ContentType: file.type,
										Body: file,
										ACL: 'public-read',
										ContentDisposition: "attachment; filename=" + file.name
									};
									
									s3.upload(params, function(err, res) {
										if (err) {
											$.notify(err.message, "error");
											ret = -1;
										}
										
										var revision = {
											"guid": guid,
											"name": params.Body.name,
											"extension": params.Body.type,
											"size": params.Body.size,
											"download": res.Location,
											"modified": params.Body.lastModifiedDate,
											"date": Date.now(),
											"preview":""
										};
										
										var resource_id = _this.parentNode.parentNode.parentNode.parentNode.dataset.guid;
										var xhttp = new XMLHttpRequest();
										xhttp.onreadystatechange = function(){
											if(this.status == 200 && this.readyState == 4){
												$.notify("Revision added.", "success");
												latest_folder_json = JSON.parse(this.responseText);
												resource_table.render(JSON.parse(this.responseText));
											}
											else{
												console.log(this.responseText);
											}
										}
										var folder = latest_folder_json;
										
										var target = null;
										for(var i = 0; i < folder.items.length; i++){
											if(folder.items[i].guid == resource_id){
												target = folder.items[i];
											}
										}
										
										target.revisions.push(revision);
										
										xhttp.open("PUT", "/api/users/" + "<%- owner._id %>" + "/resources/" + folder.guid);
										xhttp.setRequestHeader("Content-Type", "application/json");
										xhttp.send(JSON.stringify({target: target}));
										
									});
								}
							})
							file.click();
						}
					};
					
					var download_revision = {
						"download": function(){
							
							var guid = this.parentNode.parentNode.parentNode.parentNode.dataset.guid;
							
							var folder = latest_folder_json;
							var url = null;

							/* Find revision */
							for(var i = 0; i < folder.items.length; i++){
								if(folder.items[i].type == 'file'){
									console.log(folder.items[i].revisions);
									for(var j = 0; j < folder.items[i].revisions.length; j++){
										if(folder.items[i].revisions[j].guid == guid){
											url = folder.items[i].revisions[j].download;
										}
									}
								}
							}

							function downloadURI(uri) {
							  var link = document.createElement("a");
							  link.href = uri;
							  document.body.appendChild(link);
							  link.click();
							  document.body.removeChild(link);
							  delete link;
							}
							
							downloadURI(url);
		
						}
					};
					
					
					var view_revision = {
						"view": function(){
							
						}
					};
					
					var share = {
						"share": function(){
							
							var guid = this.parentNode.parentNode.parentNode.parentNode.dataset.guid;
						
							var folder = latest_folder_json;
							
							/* Has the target folder been reached? */
							for(var i = 0; i < folder.items.length; i++){
								if(folder.items[i].guid == guid){
									folder = folder.items[i];
								}
							}
							console.log(folder);
							/* Generate Close Button. */
							var close_btn = el_factory('button', {type: "button", class: "close", "data-dismiss": "modal", "aria-label": "Close"}, el_factory('span', {"aria-hidden": "true"}, "x"));
							
							/* Generate Title. */
							var title = el_factory('h3', {}, "Sharing");
							var link = window.location.href.split("resources")[0] + "resources/" + guid;
							var copy_btn = el_factory('button', {class:'btn btn-primary'}, "Copy");
							copy_btn.addEventListener('click', function(e){
								e.preventDefault();
								var copyText = document.getElementById("resource-link");

								  /* Select the text field */
								  copyText.select();

								  /* Copy the text inside the text field */
								  document.execCommand("copy");
								  
								  $.notify('link copied to clipboard.', "success");
						
							});
							var label = el_factory('input', {class: 'form-control', type: 'text', value: link, id: 'resource-link', readonly: "true"});//
							var input_group_link = el_factory('div', {class: 'input-group', style: 'margin-bottom: 10px'}, label, copy_btn);
							
							/* Generate Input. */
							var input = el_factory('input', {type: 'text', placeholder: "Email Address", class: 'form-control', id: 'share-email-input', required: 'true'});
							var share_btn = el_factory('button', {class:'btn btn-primary'}, "Share");
							var prepend = el_factory('div', {class: 'input-group-prepend'}, el_factory('span', {class: 'input-group-text'}, "@"));
							var input_group = el_factory('div', {class: 'input-group', style: 'margin-bottom: 10px'}, prepend, input, share_btn);
							
							var list_group = el_factory('ul', {class: 'list-group', id: 'sharing-list'});
							
							/* Generate Form. */
							var form = el_factory('form', {id: 'modal_form'}, close_btn, title, input_group_link, input_group);
							
							form.addEventListener('submit', function(e){
								e.preventDefault();
								/* Find user from email address. */
								var email = document.getElementById('share-email-input').value;
								console.log(email);
								var xhttp = new XMLHttpRequest();
								xhttp.onreadystatechange = function(){
									if(this.status == 200 && this.readyState == 4){
										var user = null;
										var users = JSON.parse(this.responseText);
										for(var i = 0; i < users.length; i++){
											if(users[i].email == email){
												user = users[i];
											}
										}
										if(user == null){
											return $.notify("User with email address " + email + " doesn't exist.", "error");
										}
										
										for(var i = 0; i < folder.sharing.length; i++){
											if(folder.sharing[i].email == email){
												return $.notify("You have already shared this resource with " + email + ".", "error");
											}
										}
										
										/* Add user id and email to sharing array. */
										folder.sharing.push(user);
										
										var xhttp = new XMLHttpRequest();
										xhttp.onreadystatechange = function(){
											if(this.status == 200 && this.readyState == 4){
												/* Close the modal. */
												$('#share_modal').modal('toggle');
												latest_folder_json = JSON.parse(this.responseText);
												$.notify("Resource shared with " + email + ".", "success");
											}
											else{
												console.log(this.responseText);
											}
										}

										xhttp.open("PUT", "/api/users/" + "<%- owner._id %>" + "/resources/" + latest_folder_json.guid);
										xhttp.setRequestHeader("Content-Type", "application/json");
										xhttp.send(JSON.stringify({target: folder}));

									}
									else{
										console.log(this.responseText);
									}
								}
								
								xhttp.open("GET", "/api/users");
								xhttp.send();
								
								
								
							});
							
							/* Generate Modal. */
							var modal = el_factory('div', {class: 'modal fade', style: 'top: 30% !important;', id: 'share_modal', tabindex: '-1', role: 'dialog', 'aria-hidden': 'true'},
								el_factory('div', {class: 'modal-dialog  modal-md', role: 'document'},
									el_factory('div', {class: 'modal-content', style: 'border-radius: 0; box-shadow: 0px 0px 10px 1px grey;'},
										el_factory('div', {class: 'modal-body'}, form, list_group)
									)
								)
							);
					
							$(document.body).append(modal);
							
							/* Add users to list. */
							var sharing_list = document.getElementById('sharing-list');
							for(var i = 0; i < folder.sharing.length; i++){
								var delete_btn = el_factory('button', {class:'btn btn-danger btn-sm', style: 'float: right'}, "Remove");
								delete_btn.addEventListener('click', function(){
									
									var xhttp = new XMLHttpRequest();
									xhttp.onreadystatechange = function(){
										if(this.status == 200 && this.readyState == 4){
											/* Close the modal. */
											$('#share_modal').modal('toggle');
											latest_folder_json = JSON.parse(this.responseText);
											$.notify("User removed.", "success");
										}
										else{
											console.log(this.responseText);
										}
									}
									
									folder.sharing.splice(this.parentNode.dataset.index, 1);
									
									xhttp.open("PUT", "/api/users/" + "<%- owner._id %>" + "/resources/" + latest_folder_json.guid);
									xhttp.setRequestHeader("Content-Type", "application/json");
									xhttp.send(JSON.stringify({target: folder}));
									
								});
								var list_item = el_factory('li', {class: 'list-group-item', 'data-index': i}, el_factory('span', {style: 'vertical-align: -webkit-baseline-middle', 'data-user_id': folder.sharing[i].user_id}, folder.sharing[i].email), delete_btn);
								sharing_list.appendChild(list_item);
							}
							
							/* Open the modal. */
							$('#share_modal').modal('toggle');
							
							/* Static text for link */
							
							
					
							/* Destroy the modal on close. */
							  $('#share_modal').on('hidden.bs.modal', function() {
								var elem = document.querySelector('#share_modal');
								elem.parentNode.removeChild(elem);
							  })
							
						}
					};
					
					
					if(resource_type == 'file'){
						menu_items.push(download_item);
						menu_items.push(ver_hist_item);
						menu_items.push(update);
						menu_items.push(delete_item);
						if("<%-owner.email%>" == "<%-client_email%>"){
							menu_items.push(move_item);
						}
						menu_items.push(share);
					}
	
					if(resource_type == 'folder'){
						menu_items.push(rename_item);
						menu_items.push(delete_item);
						if("<%-owner.email%>" == "<%-client_email%>"){
							menu_items.push(move_item);
						}
						menu_items.push(share);
					}
					
					/* It must be a revision. */
					if(resource_type != 'file' && resource_type != 'folder'){
					
						menu_items.push(view_revision);
						menu_items.push(download_revision);
					
					}
					
					dt_row.appendChild(this.generate_action_btn(null, menu_items));
				}
				document.getElementById(_this.config.target + '-body').appendChild(dt_row);
			}
			
			this.action_btn = function(id){
				this.add_item = function(name, callback){
					var item = el_factory('button', {class:'dropdown-item', type:'button', onclick:callback}, name);
					return item;
				}
			}
			
			this.generate_action_btn = function(id, items){
				var attr = (id != null) ? { class:'more-btn', id: id, 'data-toggle':"dropdown" } : { class:'more-btn', 'data-toggle':"dropdown" };
				var btn = el_factory('div', attr,
						el_factory('span', {class: 'dot'}),
						el_factory('span', {class: 'dot'}),
						el_factory('span', {class: 'dot'}))
				var inner_div = el_factory('div', {class: 'dropdown-menu dropdown-menu-right'});
				for(var i = 0; i < items.length; i++){
					for(prop in items[i]){
						var item = el_factory('button', {class:'dropdown-item', type:'button'}, prop);
						item.addEventListener('click', items[i][prop], false);
						inner_div.appendChild(item);
					}
				}
				var th = el_factory('th', {style:'width:10%;'}, el_factory('div', {class:'dropdown'}, btn, inner_div));
				
				return th;
			}
			
			/* Removes all nodes from the table's body. */
			this.empty = function(){
				var _this = this;
				var myNode = document.getElementById(_this.config.target + '-body');
				while (myNode.firstChild) {
					myNode.removeChild(myNode.firstChild);
				}
			}
			
			this.destroy = function(){
				var _this = this;
				var element = document.getElementById(_this.config.target);
				while (element.firstChild) {
					element.removeChild(element.firstChild);
				}
			}
			
			this.generate_checkbox = function(click_event){
				var checkbox = el_factory('input', {type: 'checkbox'});
				checkbox.addEventListener('click', click_event);
				return el_factory('td', {style: "width: 10px;"}, el_factory('label', {class: "container"}, checkbox, el_factory('span', {class: "checkmark"})));
			}
			
			/* Constructor */
			this.init = function(target, headers){
				var _this = this;
				if(target === 'undefined')
					return console.log("error: table target required");
				_this.config.target = target;
				var dt_row = document.createElement("tr");
				if(_this.config.select_btn) 
					dt_row.appendChild(el_factory('th'));
				/* One column on mobile. */
				if(window.innerWidth < 768){
					headers.length = 1;
				}
				for(var i = 0; i < headers.length; i++)
					dt_row.appendChild(el_factory('th', {}, headers[i]));
					
				if(_this.config.hdr_action_btn){
					dt_row.appendChild(this.generate_action_btn("action-btn", [
					{"Upload file": function(){
						
						/* Open file dialog. */
						var file = el_factory('input', {type: 'file'});
						file.addEventListener('change', function(){
						
							/* Upload to AWS. */
							var file = this.files[0];

							/* Upload to AWS. */
							if (file) {
								/* Generate GUID for file name. */
								guid = uuidv4();
								var objKey = "<%= owner._id %>" + '/' + guid;
								var params = {
									Key: objKey,
									ContentType: file.type,
									Body: file,
									ACL: 'public-read',
									ContentDisposition: "attachment; filename=" + file.name
								};
								
								s3.upload(params, function(err, res) {
									if (err) {
										$.notify(err.message, "error");
										ret = -1;
									}
									
									var payload = {
											"type": 'file',
											"guid": guid,
											"name": params.Body.name,
											"revisions":[
												{
													"guid": guid,
													"name": params.Body.name,
													"extension": params.Body.type,
													"size": params.Body.size,
													"download": res.Location,
													"modified": params.Body.lastModifiedDate,
													"date": Date.now(),
													"preview":"",
													"comments":"First revision."
												}
											]
										};
									
									
									var xhttp = new XMLHttpRequest();
									xhttp.onreadystatechange = function() {
										if (this.readyState == 4 && this.status == 200) {
											$.notify(params.Body.name + " added.", "success");
											latest_folder_json = JSON.parse(this.responseText);
											resource_table.render(JSON.parse(this.responseText));
										}
										else{
											console.log(this.responseText);
										}
									}
									xhttp.open("POST", '/api/users/' +  "<%= owner._id %>" +'/resources', true);
									xhttp.setRequestHeader('Content-Type', 'application/json');
									var folder = <%- folder %>;
									payload["target_folder_id"] = folder.guid;
									xhttp.send(JSON.stringify(payload)); 

								});
							}
						})
						file.click();
					}},
					{"New Folder": function(){ 
						var _this = this;
						generate_text_modal('Folder', 'Enter your folder name', false, 'Create', 
							function(args){
								
								var xhttp = new XMLHttpRequest();
								xhttp.onreadystatechange = function() {
									if (this.readyState == 4 && this.status == 200) {
										$.notify(args.INPUT + " created.", "success");
										latest_folder_json = JSON.parse(this.responseText);
										resource_table.render(JSON.parse(this.responseText));
									}
									else{
										console.log(this.responseText);
									}
								}
								xhttp.open("POST", '/api/users/' +  "<%= owner._id %>" +'/resources', true);
								xhttp.setRequestHeader('Content-Type', 'application/json');
								var folder = <%- folder %>;
								xhttp.send(JSON.stringify({owner_id: "<%= owner._id %>", target_folder_id: folder.guid, type: "folder", name: args.INPUT})); 
							
							},{});
					}}
						]));
						
				}
				
				var dt = el_factory('table', {class: 'table'}, 
							el_factory('thead', {}, dt_row), el_factory('tbody', {id: _this.config.target + '-body'})
						);
				if(_this.config.breadcrumbs)
					_this.this_breadcrumbs = new this.breadcrumbs(target, this);
				document.getElementById(target).appendChild(dt);
			}
			
			this.init(this.config.target, this.config.headers);
		}
		
		
		function generate_text_modal(_TITLE, _PLACEHOLDER, _TEXT, _BUTTON_TEXT, _CALLBACK, _ARGS) {
			
			/* Generate Close Button. */
			var close_btn = el_factory('button', {type: "button", class: "close", "data-dismiss": "modal", "aria-label": "Close"}, el_factory('span', {"aria-hidden": "true"}, "x"));
			
			/* Generate Title. */
			var title = el_factory('label', {for: 'NewDocumentName', class: 'col-form-label', style: 'padding: 10px 0px; color: black; font-weight: normal; font-size: large;'}, _TITLE);

			/* Generate Input. */
			if (!_TEXT)
				_TEXT = "";
			var style = 'border: 1px solid gray !important; color:black !important; border-radius: 0; box-shadow: none !important; outline: none !important;';
			var input = el_factory('input', {type: 'text', placeholder: _PLACEHOLDER, class: 'form-control', id: 'modal_text_input', required: 'true', value: _TEXT, style: style});
	
			/* Generate Submit Button. */
			style = 'float: right; border: none !important; color: white !important; font-weight: bold; margin-top: 15px; padding: 7px 15px; background: #007bff; font-size: small;';
			var submit_btn = el_factory('input', {type: 'submit', 'value': _BUTTON_TEXT, style: style});
		
			/* Generate Form. */
			var form = el_factory('form', {id: 'modal_form'}, close_btn, title, input, submit_btn);
			
			/* Generate Modal. */
			var modal = el_factory('div', {class: 'modal fade', style: 'top: 30% !important;', id: 'text_modal', tabindex: '-1', role: 'dialog', 'aria-hidden': 'true'},
				el_factory('div', {class: 'modal-dialog', style: 'max-width: 350px !important;', role: 'document'},
					el_factory('div', {class: 'modal-content', style: 'border-radius: 0; box-shadow: 0px 0px 10px 1px grey;'},
						el_factory('div', {class: 'modal-body'}, form)
					)
				)
			);
	
		  $(document.body).append(modal);

		  /* Open the text modal. */
		  $('#text_modal').modal('toggle');
		  
		  $("#modal_form").submit(function(event) {
			/* Stop page reloading. */
			event.preventDefault();
			/* Get text input. */
			_ARGS.INPUT = document.getElementById("modal_text_input").value;
			_ARGS.ORIGINAL = _TEXT;
			/* Clear text input. */
			document.getElementById("modal_text_input").value = '';
			/* Invoke callback function. */
			_CALLBACK(_ARGS);
			/* Close the modal. */
			$('#text_modal').modal('toggle');
		  });
		  /* Destroy the modal on close. */
		  $('#text_modal').on('hidden.bs.modal', function() {
			var elem = document.querySelector('#text_modal');
			elem.parentNode.removeChild(elem);
		  })
		}
		
		function uuidv4() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}
		
		function generate_move_modal(resource_guid){

			var folder = latest_folder_json;
			console.log(folder);
			var original = {};
					
			/* Save original resource and delete it from old location.*/
			for(var i = 0; i < folder.items.length; i++){
				if(folder.items[i].guid == resource_guid){
					original = folder.items[i]
				}
			}
			
					/* Generate Close Button. */
					var close_btn = el_factory('button', {type: "button", class: "close", "data-dismiss": "modal", "aria-label": "Close"}, el_factory('span', {"aria-hidden": "true"}, "x"));
					
					/* Generate Title. */
					var title = el_factory('label', {for: 'NewDocumentName', class: 'col-form-label', style: 'padding: 10px 0px; color: black; font-weight: normal; font-size: large;'}, "Move resource to..");
			
					/* Generate Form. */
					var form = el_factory('form', {id: 'modal_form'}, close_btn, title);
					
					/* Generate Modal. */
					var modal = el_factory('div', {class: 'modal fade', style: 'top: 30% !important;', id: 'move_modal', tabindex: '-1', role: 'dialog', 'aria-hidden': 'true'},
						el_factory('div', {class: 'modal-dialog', style: 'max-width: 350px !important;', role: 'document'},
							el_factory('div', {class: 'modal-content', style: 'border-radius: 0; box-shadow: 0px 0px 10px 1px grey;'},
								el_factory('div', {class: 'modal-body', id: 'move-modal-body'}, form, el_factory('div', {id: 'move-modal-tree'}))
							)
						)
					);
					
				  $(document.body).append(modal);
				
				
					$('#move-modal-tree').jstree({
						'plugins': ["wholerow", "checkbox"],
						'checkbox': { three_state: false, deselect_all: true },
						'core': {
							'data': {
								"type": 'GET',
								"url": function (node) {
									return '/api/users/' + "<%- owner._id %>" + '/treeview/' + resource_guid;
								},
								"success": function (new_data) {
									return new_data;
								}
							},
							'themes': {
								'name': 'proton',
								'responsive': true
							}
						}
					});
				  
				  /* Generate Submit Button. */
					style = 'float: right; border: none !important; color: white !important; font-weight: bold; margin-top: 15px; padding: 7px 15px; background: #007bff; font-size: small;';
					var submit_btn = el_factory('input', {type: 'submit', 'value': "Move", style: style});
					
					submit_btn.addEventListener('click', function(){
					
						var checked = $('#move-modal-tree').jstree("get_checked",true);
						if(checked.length != 1)
							return $.notify("Please select one folder.", "error");
						
						/* Delete from old location. */
						var xhttp = new XMLHttpRequest();
						xhttp.onreadystatechange = function() {
							if (this.readyState == 4 && this.status == 200) {
								var xhttp = new XMLHttpRequest();
								xhttp.onreadystatechange = function() {
									if (this.readyState == 4 && this.status == 200) {
										latest_folder_json = JSON.parse(this.responseText);
										resource_table.render(JSON.parse(this.responseText));
										
										$('#move_modal').modal('toggle');
										
										return $.notify(original.name + " moved.", "success");
									}
									else{
										console.log(this.responseText);
									}
								};
								xhttp.open("POST", '/api/users/' + "<%- owner._id %>" + '/resources', true);
								xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
								original["target_folder_id"] = checked[0].original.guid;
								original["current_folder_id"] = folder.guid;
								console.log(original);
								
								xhttp.send(JSON.stringify(original));
							}
							else{
								console.log(this.responseText);
							}
						};
						var folder = <%- folder %>;
						xhttp.open("DELETE", '/api/users/' + "<%- owner._id %>" + '/resources/' + folder.guid, true);
						xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
						xhttp.send(JSON.stringify({target_id : original.guid}));

					});
				  
				  document.getElementById('move-modal-body').appendChild(submit_btn);
				  
					/* Open the text modal. */
					$('#move_modal').modal('toggle');
					 /* Destroy the modal on close. */
					  $('#move_modal').on('hidden.bs.modal', function() {
						var elem = document.querySelector('#move_modal');
						elem.parentNode.removeChild(elem);
					  })
					
					
	
			
		}
		
		
	</script>
  </body>
</html>